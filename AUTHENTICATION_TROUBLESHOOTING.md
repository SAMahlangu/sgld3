# Authentication Troubleshooting Guide

## Problem Identified ✅

The issue was that the password hashes in the database were incorrect. The actual hashes generated by the app are:
- `student123` → `-1032466921` (not `-1234567890`)
- `admin123` → `-969161597` (not `-1234567891`)

## Solution Steps

### 1. Fix the Database Users

Run this SQL in your Supabase SQL editor:

```sql
-- Fix Demo Users with Correct Password Hashes
UPDATE users 
SET password_hash = '-1032466921', role = 'student'
WHERE email = 'student@example.com';

UPDATE users 
SET password_hash = '-969161597', role = 'admin'
WHERE email = 'admin@example.com';

-- Verify the changes
SELECT 
    email, 
    full_name, 
    role, 
    CASE 
        WHEN password_hash = '-1032466921' THEN 'student123'
        WHEN password_hash = '-969161597' THEN 'admin123'
        ELSE 'unknown'
    END as password,
    created_at
FROM users 
WHERE email IN ('student@example.com', 'admin@example.com')
ORDER BY email;
```

### 2. Test the Login

After running the SQL above, try logging in with:
- **Student**: `student@example.com` / `student123`
- **Admin**: `admin@example.com` / `admin123`

### 3. Check Browser Console

Open your browser's developer tools (F12) and check the console for detailed login debug information. The updated login function now provides extensive logging.

## Debug Information

### Enhanced Login Debugging

The login function now includes detailed debugging:

1. **Connection Test**: Verifies database connectivity
2. **Query Execution**: Shows if the user query runs successfully
3. **User Found**: Displays user details when found
4. **Hash Comparison**: Shows stored vs attempted password hashes
5. **Session Creation**: Confirms user session setup

### Console Output Example

```
=== LOGIN DEBUG START ===
Starting login for: student@example.com
Hashed password: -1032466921
Database connection successful
Query executed successfully
Users found: 1
User found successfully: {id: "123", email: "student@example.com", full_name: "Demo Student", role: "student"}
Setting user session: {id: "123", email: "student@example.com", full_name: "Demo Student", role: "student"}
User context being set...
User context set successfully
Login successful, session created
=== LOGIN DEBUG END (SUCCESS) ===
```

## Common Issues and Solutions

### Issue 1: "No user found with email"
**Cause**: User doesn't exist in database
**Solution**: Add the user using the SQL scripts provided

### Issue 2: "User exists but password hash mismatch"
**Cause**: Wrong password hash in database
**Solution**: Update the password hash using the fix script

### Issue 3: "Database connection failed"
**Cause**: Supabase connection issues
**Solution**: Check environment variables and network connectivity

### Issue 4: "Login successful but can't access dashboard"
**Cause**: Role-based access issue
**Solution**: Verify user role is set correctly in database

## Verification Steps

### 1. Check Database Users
```sql
SELECT email, full_name, role, password_hash 
FROM users 
WHERE email IN ('student@example.com', 'admin@example.com');
```

### 2. Test Password Hashing
Run the test script:
```bash
node test-password-hash.js
```

### 3. Verify Environment Variables
Check that your `.env` file has:
```
VITE_SUPABASE_URL=your_supabase_url
VITE_SUPABASE_ANON_KEY=your_supabase_anon_key
```

### 4. Test Database Connection
Use the debug tools in the login form to test the connection.

## Files Updated

1. **`src/contexts/AuthContext.tsx`**: Enhanced debugging and error handling
2. **`src/lib/supabase.ts`**: Simplified user context setting
3. **`fix-demo-users.sql`**: SQL script to fix demo users
4. **`test-password-hash.js`**: Password hash verification script
5. **`password-hash-generator.html`**: Updated with correct demo hashes

## Role-Based Access

After successful login, users will be redirected based on their role:

- **Students** (`role = 'student'`): Redirected to `/dashboard`
- **Admins** (`role = 'admin'`): Can access `/admin` dashboard

## Next Steps

1. **Run the fix script** in your Supabase SQL editor
2. **Test login** with both demo accounts
3. **Check console logs** for detailed debugging information
4. **Verify role-based access** works correctly

## Support

If you still have issues:
1. Check the browser console for detailed error messages
2. Verify the database users have correct password hashes
3. Test the database connection using the debug tools
4. Ensure environment variables are set correctly 